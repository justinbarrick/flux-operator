workspace:
  base: /go
  path: src/github.com/justinbarrick/flux-operator

pipeline:
  check-config:
    image: golang:1.9-alpine
    commands:
      - apk update && apk add make git
      - make generate-crds
      - echo "Checking if generated files are different than commited, will fail if changes are detected."
      - git diff --exit-code
    when:
      event: push

  test:
    image: presslabs/kluster-toolbox
    secrets: [ SSH_KEY ]
    environment:
      - KUBECONFIG=/go/.kube/config
      - DOCKER_HOST=tcp://minikube:2375
    commands:
      - ./integration-test.sh
    when:
      event: push

  publish:
    image: presslabs/kluster-toolbox
    secrets: [ DOCKER_USER, DOCKER_PASSWORD ]
    environment:
      - DOCKER_HOST=tcp://minikube:2375
    commands:
      - set +x
      - docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
      - set -x
      - docker tag justinbarrick/flux-operator:latest justinbarrick/flux-operator:${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:7}
      - docker push justinbarrick/flux-operator:latest
      - docker push justinbarrick/flux-operator:${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:7}
    when:
      branch: master
      event: push

services:
  minikube:
    image: justinbarrick/drone-minikube:stable2
    privileged: true
    commands:
    - echo nameserver 8.8.8.8 > /etc/resolv.conf
    - /usr/local/bin/docker-entrypoint.sh start
    when:
      event: push
